<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Emoji Flux ‚Äî Stable</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg1:#071029; --bg2:#0b1830;
      --accent:#ffd166; --muted:#bcd3ea;
      --slot-size:90px; --slot-gap:12px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
      color:var(--muted);
      background: linear-gradient(180deg,var(--bg1),var(--bg2));
      -webkit-font-smoothing:antialiased;
      display:flex;flex-direction:column;align-items:center;padding:18px;
    }

    header{width:100%;max-width:980px;display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .brand{font-weight:700;color:var(--accent)}
    .controls{display:flex;gap:10px;align-items:center}

    .panel{width:100%;max-width:980px;background:rgba(255,255,255,0.02);border-radius:12px;padding:16px;box-shadow:0 20px 60px rgba(0,0,0,0.6)}
    .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .score{font-weight:700;padding:6px 10px;border-radius:10px;background:rgba(255,255,255,0.02)}

    .grid{display:grid;grid-template-columns:repeat(3,var(--slot-size));grid-gap:var(--slot-gap);justify-content:center;padding:12px;border-radius:10px}
    .slot{
      height:var(--slot-size); width:var(--slot-size); border-radius:12px; display:flex;align-items:center;justify-content:center;
      font-size:44px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.008));
      box-shadow:0 12px 36px rgba(0,0,0,0.6), inset 0 -8px 16px rgba(0,0,0,0.22);
      transition: transform .22s, box-shadow .18s, filter .18s;
    }
    .slot.enter{opacity:0; transform: translateY(-28px) scale(.96); animation:slot-in .46s cubic-bezier(.2,.9,.3,1) var(--delay) both}
    @keyframes slot-in{0%{opacity:0;transform:translateY(-28px) scale(.96)}60%{transform:translateY(6px) scale(1.06)}100%{opacity:1;transform:translateY(0) scale(1)}}
    .slot.win{transform:scale(1.08); box-shadow:0 28px 80px rgba(255,200,80,0.14); filter:brightness(1.12)}

    .actions{display:flex;gap:12px;justify-content:center;margin-top:12px}
    button{padding:10px 14px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--accent),#ffb86b);cursor:pointer;font-weight:700;color:#08101a}

    aside{width:320px;display:flex;flex-direction:column;gap:12px;margin-top:12px}
    .aside-section{background:rgba(255,255,255,0.02);padding:12px;border-radius:10px}
    .muted{color:var(--muted);font-size:0.92rem}

    canvas#confetti{position:fixed;left:0;top:0;pointer-events:none;z-index:120}

    @media (max-width:880px){ :root{--slot-size:72px} aside{width:100%} }
  </style>
</head>
<body>
  <canvas id="confetti"></canvas>

  <header>
    <div class="brand">Emoji Flux</div>
    <div class="controls">
      <input id="nick" placeholder="–ù–∏–∫–Ω–µ–π–º" style="padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit" />
      <button id="saveNick">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </header>

  <div class="panel">
    <div class="top">
      <div style="display:flex;gap:12px;align-items:center">
        <label class="muted">–°—Ç–∞–≤–∫–∞</label>
        <input id="bet" type="number" value="20" min="1" style="width:110px;padding:6px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit" />
        <button id="min">–ú–∏–Ω</button>
        <button id="half">1/2</button>
        <button id="max">–ú–∞–∫—Å</button>
      </div>
      <div class="score" id="score">–ù–∞–∂–º–∏—Ç–µ ¬´Spin¬ª</div>
    </div>

    <div class="grid" id="grid" role="grid" aria-live="polite"></div>

    <div class="actions">
      <button id="spin">Spin</button>
      <button id="daily">–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –∫—É–±–∏–∫</button>
      <button id="reset">–°–±—Ä–æ—Å–∏—Ç—å</button>
    </div>
  </div>

  <aside>
    <div class="aside-section">
      <div>–ë–∞–ª–∞–Ω—Å: <strong id="balance">‚Äî</strong></div>
      <div class="muted">–ö—ç—à–±–µ–∫ (vault): <span id="vault">0</span></div>
    </div>

    <div class="aside-section">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700">–ë–æ–ª—å—à–∏–µ –≤—ã–∏–≥—Ä—ã—à–∏</div>
        <button id="clearBig">–û—á–∏—Å—Ç–∏—Ç—å</button>
      </div>
      <div id="bigList" style="margin-top:8px;max-height:260px;overflow:auto"></div>
    </div>

    <div class="aside-section">
      <div class="muted">–û–Ω–ª–∞–π–Ω: <strong id="online">‚Äî</strong></div>
      <div class="muted">–ì–ª–æ–±. —É–¥–∞—á–∞: <span id="luck">1.00</span></div>
    </div>
  </aside>

  <script>
  // Stable, single-file game with visible slots and robust JS (no duplicate declarations)

  // Config
  const EMOJI = ['üçí','üçã','üîî','‚≠ê','üçÄ','üíé','7Ô∏è‚É£','üçé','‚ö°Ô∏è'];
  const ROWS = 3, COLS = 3, SLOT_COUNT = ROWS * COLS;

  // DOM
  const gridEl = document.getElementById('grid');
  const balanceEl = document.getElementById('balance');
  const vaultEl = document.getElementById('vault');
  const scoreEl = document.getElementById('score');
  const bigListEl = document.getElementById('bigList');
  const onlineEl = document.getElementById('online');
  const luckEl = document.getElementById('luck');
  const confettiCanvas = document.getElementById('confetti');

  const nickInput = document.getElementById('nick');
  const saveNickBtn = document.getElementById('saveNick');
  const spinBtn = document.getElementById('spin');
  const dailyBtn = document.getElementById('daily');
  const resetBtn = document.getElementById('reset');
  const betInput = document.getElementById('bet');
  const minBtn = document.getElementById('min');
  const halfBtn = document.getElementById('half');
  const maxBtn = document.getElementById('max');
  const clearBigBtn = document.getElementById('clearBig');

  // State (persisted)
  let nick = localStorage.getItem('nick') || 'Player';
  nickInput.value = nick;
  let balance = Number(localStorage.getItem('balance')) || 1000;
  let vault = Number(localStorage.getItem('vault')) || 0;
  let bigWins = JSON.parse(localStorage.getItem('localBigWins') || '[]');

  // Create grid slots
  function createGrid(){
    gridEl.innerHTML = '';
    for (let i=0;i<SLOT_COUNT;i++){
      const slot = document.createElement('div');
      slot.className = 'slot';
      slot.textContent = EMOJI[i % EMOJI.length];
      gridEl.appendChild(slot);
    }
  }
  createGrid();

  // Lightweight confetti system (single array)
  const confettiCtx = confettiCanvas.getContext('2d');
  let C_W=0,C_H=0, confettiParts=[], confettiAnimating=false;
  function resizeCanvas(){ C_W = confettiCanvas.width = innerWidth; C_H = confettiCanvas.height = innerHeight; }
  addEventListener('resize', resizeCanvas); resizeCanvas();

  function confettiSpawn(x,y,n=60){
    for (let i=0;i<n;i++){
      confettiParts.push({
        x: x + (Math.random()-0.5)*160,
        y: y + (Math.random()-0.5)*120,
        vx: (Math.random()-0.5)*12,
        vy: -Math.random()*12 - 2,
        r: Math.random()*8+4,
        col: ['#ffd166','#6ee7b7','#60a5fa','#f472b6','#fff59d'][Math.floor(Math.random()*5)],
        life: 0, ttl: 80 + Math.floor(Math.random()*120)
      });
    }
    if (!confettiAnimating) confettiLoop();
  }
  function confettiLoop(){
    confettiAnimating = true;
    confettiCtx.clearRect(0,0,C_W,C_H);
    for (let i=confettiParts.length-1;i>=0;i--){
      const p = confettiParts[i];
      p.life++; p.vy += 0.35; p.x += p.vx; p.y += p.vy;
      confettiCtx.save(); confettiCtx.translate(p.x,p.y); confettiCtx.rotate(p.life*0.07);
      confettiCtx.fillStyle = p.col; confettiCtx.fillRect(-p.r/2, -p.r/2, p.r, p.r*0.6);
      confettiCtx.restore();
      if (p.y > C_H + 50 || p.life > p.ttl) confettiParts.splice(i,1);
    }
    if (confettiParts.length>0) requestAnimationFrame(confettiLoop);
    else confettiAnimating = false;
  }

  // Grid animation + results
  function animateGrid(values, winIndices=[]){
    const slots = Array.from(gridEl.children);
    slots.forEach((s,i)=>{
      s.className = 'slot enter';
      s.style.setProperty('--delay', `${(i%COLS)*0.04}s`);
      s.textContent = values[i] || '‚ùî';
      const onEnd = () => {
        s.classList.remove('enter');
        s.removeEventListener('animationend', onEnd);
        if (winIndices.includes(i)){
          s.classList.add('win');
          setTimeout(()=> s.classList.remove('win'), 1000);
        }
      };
      s.addEventListener('animationend', onEnd);
    });
  }

  // Compute lines and payouts
  function computeLines(arr){
    const lines = [];
    for (let r=0;r<ROWS;r++) lines.push([arr[r*COLS], arr[r*COLS+1], arr[r*COLS+2]]);
    for (let c=0;c<COLS;c++) lines.push([arr[c], arr[3+c], arr[6+c]]);
    lines.push([arr[0],arr[4],arr[8]]);
    lines.push([arr[2],arr[4],arr[6]]);
    return lines.map(vals=>{
      const freq={};
      vals.forEach(v=> freq[v] = (freq[v]||0)+1);
      const best = Math.max(...Object.values(freq));
      const emoji = Object.keys(freq).find(k=>freq[k]===best);
      return { vals, bestCount: best, emoji };
    });
  }

  function payoutFromLines(bet, lineResults){
    let totalMul = 0, winCells = [];
    lineResults.forEach((lr, idx)=>{
      const c = lr.bestCount;
      if (c >= 3){
        totalMul += (c===3 ? 3 : (c===4?6:12));
        if (idx < 3){ const r=idx; for (let cc=0; cc<COLS; cc++) winCells.push(r*COLS + cc); }
        else if (idx < 6){ const cc = idx - 3; for (let rr=0; rr<ROWS; rr++) winCells.push(rr*COLS + cc); }
        else if (idx===6) winCells.push(0,4,8); else winCells.push(2,4,6);
      } else if (c===2) totalMul += 0.6;
    });
    totalMul = Math.min(totalMul, 50);
    const payout = Math.round(bet * totalMul);
    return { payout, net: payout - bet, totalMul, winCells: [...new Set(winCells)] };
  }

  // RNG generator
  function generateGrid(){
    const online = Number(onlineEl.textContent) || 1;
    const favor = Math.min(0.28 * (1 + Math.log(online+1) * 0.05 - 1), 0.45);
    const res = [];
    for (let i=0;i<SLOT_COUNT;i++){
      if (i>0 && Math.random() < Math.abs(favor)){
        res.push(Math.random() < 0.68 ? res[i-1] : res[Math.floor(Math.random()*i)]);
      } else {
        res.push(EMOJI[Math.floor(Math.random()*EMOJI.length)]);
      }
    }
    return res;
  }

  // Spin flow
  function runSpin(){
    let bet = Math.floor(Number(betInput.value) || 0);
    if (bet < 1) bet = 1;
    if (bet > balance){ alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤'); return; }
    balance -= bet; localStorage.setItem('balance', String(balance)); refreshUI();
    spinBtn.disabled = true;
    scoreEl.textContent = '–ö—Ä—É—Ç–∏—Ç—Å—è‚Ä¶';

    const result = generateGrid();
    animateGrid(result);

    const lines = computeLines(result);
    const payoutObj = payoutFromLines(bet, lines);

    setTimeout(()=>{
      if (payoutObj.payout > 0){ balance += payoutObj.payout; localStorage.setItem('balance', String(balance)); }
      const net = payoutObj.net;
      if (net > 0) scoreEl.textContent = `BIG WIN! +${net} ‚ÇΩ (–≤—ã–ø–ª–∞—Ç–∞ ${payoutObj.payout} ‚ÇΩ)`;
      else if (net === 0) scoreEl.textContent = `–ù–∏—á—å—è ‚Äî –≤–æ–∑–≤—Ä–∞—â–µ–Ω–æ ${payoutObj.payout} ‚ÇΩ`;
      else scoreEl.textContent = `–ü—Ä–æ–∏–≥—Ä—ã—à ${-net} ‚ÇΩ`;

      // effects
      const rect = gridEl.getBoundingClientRect();
      if (net >= 800){
        confettiSpawn(rect.left + rect.width/2, rect.top + rect.height/2, 260);
        showBadge(net);
      } else if (net >= 200){
        confettiSpawn(rect.left + rect.width/2, rect.top + rect.height/2, 120);
        showBadge(net);
      } else if (net > 0){
        confettiSpawn(rect.left + rect.width/2, rect.top + rect.height/2, 48);
      }

      animateGrid(result, payoutObj.winCells);

      if (net >= 50) {
        bigWins.unshift({ nick: nickInput.value || nick, emoji: lines.find(l=>l.bestCount>=3)?.emoji || result[4], amount: net, bet, payout: payoutObj.payout, ts: Date.now() });
        if (bigWins.length > 200) bigWins = bigWins.slice(0,200);
        localStorage.setItem('localBigWins', JSON.stringify(bigWins));
      }

      spinBtn.disabled = false;
      refreshUI();
    }, 620);
  }

  // daily dice
  function canDaily(){
    const last = Number(localStorage.getItem('lastDaily') || 0);
    return (Date.now() - last) >= 24*60*60*1000;
  }
  dailyBtn.addEventListener('click', ()=>{
    if (!canDaily()){ alert('–ö—É–±–∏–∫ –¥–æ—Å—Ç—É–ø–µ–Ω —Ä–∞–∑ –≤ 24 —á–∞—Å–∞'); return; }
    const roll = Math.floor(Math.random()*6)+1;
    const reward = 100 * roll;
    balance += reward; localStorage.setItem('balance', String(balance));
    localStorage.setItem('lastDaily', String(Date.now()));
    bigWins.unshift({ nick: nickInput.value || nick, emoji: 'üé≤', amount: reward, bet: 0, payout: reward, ts: Date.now() });
    if (bigWins.length > 200) bigWins = bigWins.slice(0,200);
    localStorage.setItem('localBigWins', JSON.stringify(bigWins));
    const rect = gridEl.getBoundingClientRect();
    confettiSpawn(rect.left + rect.width/2, rect.top + rect.height/2, 140);
    scoreEl.textContent = `–ö—É–±–∏–∫: ${roll} ‚Äî +${reward} ‚ÇΩ`;
    refreshUI();
    alert(`–í—ã–ø–∞–ª–æ ${roll} ‚Äî –≤—ã –ø–æ–ª—É—á–∏–ª–∏ ${reward} ‚ÇΩ`);
  });

  // show badge
  function showBadge(amount){
    winBadge.innerHTML = `BIG WIN<div style="font-size:14px;font-weight:700;margin-top:6px">+${amount} ‚ÇΩ</div>`;
    winBadge.classList.add('show');
    setTimeout(()=> winBadge.classList.remove('show'), 2400);
  }

  // UI helpers
  function refreshUI(){
    balanceEl.textContent = `${balance} ‚ÇΩ`;
    vaultEl.textContent = `${vault} ‚ÇΩ`;
    renderBigWins();
  }
  function renderBigWins(){
    bigListEl.innerHTML = '';
    if (!bigWins || bigWins.length === 0){
      bigListEl.innerHTML = '<div style="color:var(--muted);padding:8px">–ü–æ–∫–∞ –Ω–µ—Ç –±–æ–ª—å—à–∏—Ö –≤—ã–∏–≥—Ä—ã—à–µ–π</div>';
      return;
    }
    bigWins.slice(0,50).forEach(it=>{
      const row = document.createElement('div');
      row.style.display='flex'; row.style.justifyContent='space-between'; row.style.padding='8px'; row.style.borderBottom='1px solid rgba(255,255,255,0.02)';
      const left = document.createElement('div'); left.style.display='flex'; left.style.gap='8px'; left.style.alignItems='center';
      const em = document.createElement('div'); em.textContent = it.emoji || 'üéâ'; em.style.fontSize='18px';
      const info = document.createElement('div');
      const n = document.createElement('div'); n.style.fontWeight='700'; n.textContent = it.nick;
      const t = document.createElement('div'); t.style.fontSize='12px'; t.style.color='var(--muted)'; t.textContent = new Date(it.ts).toLocaleString();
      info.appendChild(n); info.appendChild(t); left.appendChild(em); left.appendChild(info);
      const right = document.createElement('div'); right.style.color='var(--accent)'; right.textContent = `+${it.amount} ‚ÇΩ`;
      row.appendChild(left); row.appendChild(right); bigListEl.appendChild(row);
    });
  }

  // storage & bindings
  spinBtn.addEventListener('click', ()=> { try{ if (audioCtx && audioCtx.state==='suspended') audioCtx.resume(); }catch(e){}; runSpin(); });
  minBtn.addEventListener('click', ()=> betInput.value = 1);
  halfBtn.addEventListener('click', ()=> betInput.value = Math.max(1, Math.floor(balance/2)));
  maxBtn.addEventListener('click', ()=> betInput.value = balance);
  saveNickBtn.addEventListener('click', ()=> { nick = nickInput.value || 'Player'; localStorage.setItem('nick', nick); alert('–ù–∏–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω'); });
  resetBtn.addEventListener('click', ()=> { if (!confirm('–°–±—Ä–æ—Å–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ?')) return; localStorage.clear(); location.reload(); });
  clearBigBtn.addEventListener('click', ()=> { if (!confirm('–û—á–∏—Å—Ç–∏—Ç—å —Å–ø–∏—Å–æ–∫ –±–æ–ª—å—à–∏—Ö –≤—ã–∏–≥—Ä—ã—à–µ–π?')) return; bigWins = []; localStorage.removeItem('localBigWins'); renderBigWins(); });

  // basic simulated online
  setInterval(()=> { const n = Math.max(1, Math.floor(Math.random()*12)+2); onlineEl.textContent = n; luckEl.textContent = (1 + 0.06 * Math.log(n + 1)).toFixed(2); }, 3500);

  // confetti parts array used above (single name)
  const parts = []; // used by confetti functions

  // WebAudio simple (optional)
  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  const audioCtx = AudioCtx ? new AudioCtx() : null;
  function tone(freq, dur=0.12, type='sine', vol=0.06){
    if (!audioCtx) return;
    const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
    o.type = type; o.frequency.value = freq; g.gain.value = vol;
    o.connect(g); g.connect(audioCtx.destination); o.start();
    g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + dur);
    setTimeout(()=> { try{ o.stop(); }catch(e){} }, dur*1000+20);
  }

  // initial seed & UI
  (function seed(){
    const base = Array.from({length:SLOT_COUNT}, (_,i) => EMOJI[(i*2) % EMOJI.length]);
    animateGrid(base);
    scoreEl.textContent = '–ì–æ—Ç–æ–≤–æ';
    refreshUI();
  })();

  </script>
</body>
</html>
