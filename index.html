<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Emoji Flux ‚Äî Enhanced (fixed)</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Bebas+Neue&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg-1: #071029;
      --bg-2: #0b1830;
      --card: rgba(255,255,255,0.02);
      --accent: #ffd166;
      --accent-2: #6ee7b7;
      --muted: #b7c9e0;
      --slot-size: 92px;
      --slot-gap: 14px;
    }

    html,body{height:100%}
    body{
      margin:0;
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      color:var(--muted);
      background:
        radial-gradient(800px 400px at 10% 10%, rgba(12,24,48,0.18), transparent),
        linear-gradient(180deg,var(--bg-1),var(--bg-2));
      -webkit-font-smoothing:antialiased;
      display:flex;
      flex-direction:column;
    }

    header{
      display:flex;align-items:center;justify-content:space-between;
      padding:14px 18px;border-bottom:1px solid rgba(255,255,255,0.02);
      background: linear-gradient(180deg, rgba(255,255,255,0.01), transparent);
    }
    .brand{font-weight:700;color:var(--accent);letter-spacing:1px;font-size:1.05rem;text-shadow: 0 8px 30px rgba(0,0,0,0.5);}
    .controls{display:flex;gap:12px;align-items:center}
    .controls input, .controls select{background:transparent;border:1px solid rgba(255,255,255,0.05);padding:8px;border-radius:10px;color:inherit}
    .controls button{padding:8px 12px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--accent),#ffb86b);font-weight:700;color:#08101a;cursor:pointer}

    main{display:flex;gap:18px;padding:18px;align-items:flex-start;flex:1}
    .field{flex:1;display:flex;flex-direction:column;align-items:center;gap:14px}
    .panel{width:100%;max-width:980px;padding:18px;border-radius:14px;background: linear-gradient(180deg, var(--card), rgba(255,255,255,0.008));box-shadow: 0 18px 50px rgba(0,0,0,0.65);display:flex;flex-direction:column;align-items:center;gap:14px;}

    .top-controls{display:flex;align-items:center;justify-content:space-between;width:100%}
    .bet-group{display:flex;gap:8px;align-items:center}
    input[type="number"]{padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}

    .grid-wrap{position:relative}
    .grid{
      display:grid;
      grid-template-columns: repeat(3, var(--slot-size));
      grid-gap: var(--slot-gap);
      padding:14px;border-radius:12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02));
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.02);
    }
    .slot{width:var(--slot-size); height:var(--slot-size); border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:44px; color:#fff; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); box-shadow: 0 10px 28px rgba(0,0,0,0.6), inset 0 -8px 16px rgba(0,0,0,0.28); transform-origin:center; transition: transform .26s cubic-bezier(.2,.9,.3,1), box-shadow .2s;}
    .slot.enter{opacity:0; transform: translateY(-28px) scale(.96); animation:slot-in .46s both}
    @keyframes slot-in{0%{opacity:0;transform:translateY(-28px) scale(.96)}60%{transform:translateY(6px) scale(1.06)}100%{opacity:1;transform:translateY(0) scale(1)}}
    .slot.win{box-shadow:0 18px 80px rgba(255,200,80,0.14); transform:scale(1.08); filter:brightness(1.12)}

    .actions{display:flex;gap:12px}
    .actions button{padding:10px 14px;border-radius:12px;border:none;background:linear-gradient(90deg,var(--accent),#ffb86b);font-weight:700;cursor:pointer}

    aside{width:340px;display:flex;flex-direction:column;gap:12px}
    .aside-section{background:var(--card);padding:12px;border-radius:10px}
    .small{font-size:0.92rem;color:var(--muted)}
    .balance{font-weight:800;color:var(--accent)}

    .win-badge{position:fixed;left:50%;top:10%;transform:translateX(-50%);z-index:120;font-family:"Bebas Neue", sans-serif;font-size:56px;color:#08101a;padding:16px 30px;border-radius:16px;background:linear-gradient(90deg,#fff1c8,#ffd166);box-shadow: 0 22px 60px rgba(255,200,80,0.16), 0 6px 24px rgba(0,0,0,0.5);opacity:0;pointer-events:none}
    .win-badge.show{animation:winpop .9s forwards}
    @keyframes winpop{0%{transform:translateX(-50%) translateY(-12px) scale(.75);opacity:0}40%{transform:translateX(-50%) translateY(4px) scale(1.16);opacity:1}100%{transform:translateX(-50%) translateY(0) scale(1)}}

    canvas#fx{position:fixed;left:0;top:0;pointer-events:none;z-index:100}

    @media (max-width:900px){main{flex-direction:column} aside{width:100%} .win-badge{font-size:44px}}
  </style>
</head>
<body>
  <canvas id="fx"></canvas>
  <div class="win-badge" id="winBadge">BIG WIN</div>

  <header>
    <div class="brand">Emoji Flux ‚Äî Enhanced</div>
    <div class="controls">
      <input id="nick" type="text" placeholder="–ù–∏–∫–Ω–µ–π–º" maxlength="20" />
      <button id="saveNick">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </header>

  <main>
    <section class="field">
      <div class="panel">
        <div class="top-controls">
          <div class="bet-group">
            <label class="small">–°—Ç–∞–≤–∫–∞</label>
            <input id="bet" type="number" min="1" value="20" />
            <button id="min">–ú–∏–Ω</button>
            <button id="half">1/2</button>
            <button id="max">–ú–∞–∫—Å</button>
          </div>
          <div class="score" id="score">–ù–∞–∂–º–∏—Ç–µ ¬´–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ—Ç–æ–∫¬ª</div>
        </div>

        <div class="grid-wrap" aria-live="polite">
          <div class="grid" id="grid" role="grid"></div>
        </div>

        <div class="actions">
          <button id="spin">–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ—Ç–æ–∫</button>
          <button id="daily">–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –∫—É–±–∏–∫</button>
        </div>
      </div>
    </section>

    <aside>
      <div class="aside-section">
        <div>–ë–∞–ª–∞–Ω—Å: <span class="balance" id="balance">‚Äî</span></div>
        <div class="small">–ö—ç—à–±–µ–∫ (vault): <span id="vault">0</span></div>
      </div>

      <div class="aside-section">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">–ë–æ–ª—å—à–∏–µ –≤—ã–∏–≥—Ä—ã—à–∏</div>
          <button id="clearBig">–û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
        <div id="bigList" style="margin-top:8px;max-height:260px;overflow:auto"></div>
      </div>

      <div class="aside-section">
        <div class="small">–û–Ω–ª–∞–π–Ω: <strong id="online">‚Äî</strong></div>
        <div class="small">–ì–ª–æ–±. —É–¥–∞—á–∞: <span id="luck">1.00</span></div>
      </div>
    </aside>
  </main>

  <script>
  // Single-file fixed implementation ‚Äî no duplicate declarations

  // Config
  const EMOJI = ['üî•','‚ö°Ô∏è','üíß','üçÄ','üåü','üéØ','üçé','üíé','üåä','‚òÑÔ∏è','‚ú®','üéµ','üé≤'];
  const ROWS = 3, COLS = 3, SLOT_COUNT = ROWS * COLS;

  // DOM refs
  const gridEl = document.getElementById('grid');
  const balanceEl = document.getElementById('balance');
  const vaultEl = document.getElementById('vault');
  const scoreEl = document.getElementById('score');
  const bigListEl = document.getElementById('bigList');
  const onlineEl = document.getElementById('online');
  const luckEl = document.getElementById('luck');
  const fxCanvas = document.getElementById('fx');
  const winBadge = document.getElementById('winBadge');

  const nickInput = document.getElementById('nick');
  const saveNickBtn = document.getElementById('saveNick');
  const spinBtn = document.getElementById('spin');
  const dailyBtn = document.getElementById('daily');
  const minBtn = document.getElementById('min');
  const halfBtn = document.getElementById('half');
  const maxBtn = document.getElementById('max');
  const betInput = document.getElementById('bet');
  const clearBigBtn = document.getElementById('clearBig');

  // State (persisted)
  let nick = localStorage.getItem('nick') || 'Player';
  nickInput.value = nick;
  let balance = Number(localStorage.getItem('balance')) || 1000;
  let vault = Number(localStorage.getItem('vault')) || 0;
  let bigWins = JSON.parse(localStorage.getItem('localBigWins') || '[]');

  // FX canvas sizing
  let W = 0, H = 0;
  function resizeFX(){ W = fxCanvas.width = innerWidth; H = fxCanvas.height = innerHeight; }
  addEventListener('resize', resizeFX); resizeFX();

  // Particles array (declared once)
  const particles = [];

  const fxCtx = fxCanvas.getContext('2d');

  function spawnParticles(x,y,count=60,spread=160,power=16,colors){
    for (let i=0;i<count;i++){
      particles.push({
        x: x + (Math.random()-0.5)*spread,
        y: y + (Math.random()-0.5)*spread,
        vx: (Math.random()-0.5)*power,
        vy: -Math.random()*power - 4,
        r: Math.random()*8+4,
        life: 0,
        ttl: 80 + Math.floor(Math.random()*100),
        col: (colors && colors[Math.floor(Math.random()*colors.length)]) || ['#ffd166','#6ee7b7','#60a5fa','#f472b6'][Math.floor(Math.random()*4)]
      });
    }
    if (!fxRunning) fxTick();
  }

  let fxRunning = false;
  function fxTick(){
    fxRunning = true;
    fxCtx.clearRect(0,0,W,H);
    for (let i=particles.length-1;i>=0;i--){
      const p = particles[i];
      p.life++; p.vy += 0.34; p.x += p.vx; p.y += p.vy;
      fxCtx.globalAlpha = Math.max(0, 1 - p.life / p.ttl);
      fxCtx.fillStyle = p.col;
      fxCtx.beginPath();
      fxCtx.ellipse(p.x, p.y, p.r, p.r*0.6, p.life*0.03, 0, Math.PI*2);
      fxCtx.fill();
      if (p.life > p.ttl || p.y > H + 50) particles.splice(i,1);
    }
    fxCtx.globalAlpha = 1;
    if (particles.length>0) requestAnimationFrame(fxTick);
    else fxRunning = false;
  }

  // WEB AUDIO (single definitions)
  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  const audioCtx = AudioCtx ? new AudioCtx() : null;
  function tone(freq, duration=0.12, type='sine', vol=0.06){
    if (!audioCtx) return;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = type; o.frequency.value = freq;
    g.gain.value = vol;
    o.connect(g); g.connect(audioCtx.destination);
    o.start();
    g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration);
    setTimeout(()=> { try{ o.stop(); }catch(e){} }, duration*1000+20);
  }
  function winSound(level='small'){
    if (!audioCtx) return;
    if (level==='small'){ tone(880,0.06,'sine',0.05); }
    else if (level==='big'){ tone(540,0.14,'triangle',0.11); tone(1300,0.12,'sine',0.08); }
    else { tone(420,0.26,'sawtooth',0.14); tone(1100,0.22,'sine',0.12); }
  }

  // Grid helpers
  function createGrid(){
    gridEl.innerHTML = '';
    for (let i=0;i<SLOT_COUNT;i++){
      const d = document.createElement('div');
      d.className = 'slot';
      gridEl.appendChild(d);
    }
  }
  createGrid();

  function animateGrid(arr, winIdx=[]){
    const slots = Array.from(gridEl.children);
    slots.forEach((s,i)=>{
      s.className = 'slot enter';
      s.style.setProperty('--delay', `${(i%COLS)*0.05}s`);
      s.textContent = arr[i] || '‚ùî';
      const onEnd = () => {
        s.classList.remove('enter'); s.removeEventListener('animationend', onEnd);
        if (winIdx.includes(i)){ s.classList.add('win'); setTimeout(()=> s.classList.remove('win'), 1000); }
      };
      s.addEventListener('animationend', onEnd);
    });
  }

  function computeLines(arr){
    const lines = [];
    for (let r=0;r<ROWS;r++){ const vals=[]; for (let c=0;c<COLS;c++) vals.push(arr[r*COLS + c]); lines.push(vals); }
    for (let c=0;c<COLS;c++){ const vals=[]; for (let r=0;r<ROWS;r++) vals.push(arr[r*COLS + c]); lines.push(vals); }
    lines.push([arr[0],arr[4],arr[8]]); lines.push([arr[2],arr[4],arr[6]]);
    return lines.map(v=>{ const freq={}; v.forEach(x=>freq[x]=(freq[x]||0)+1); const best = Math.max(...Object.values(freq)); const emoji = Object.keys(freq).find(k=>freq[k]===best); return { vals:v, bestCount: best, emoji }; });
  }

  function payout(bet, lines){
    let mul = 0; let winCells = [];
    lines.forEach((lr, idx) => {
      const c = lr.bestCount;
      if (c >= 3){
        mul += (c===3?3:(c===4?6:12));
        if (idx < 3){ const r=idx; for (let cc=0;cc<COLS;cc++) winCells.push(r*COLS+cc); }
        else if (idx < 6){ const cc = idx-3; for (let rr=0;rr<ROWS;rr++) winCells.push(rr*COLS+cc); }
        else if (idx===6) winCells.push(0,4,8); else winCells.push(2,4,6);
      } else if (c===2) mul += 0.6;
    });
    mul = Math.min(mul, 50);
    const pay = Math.round(bet * mul);
    return { payout: pay, multiplier: mul, winCells: [...new Set(winCells)] };
  }

  // UI and storage helpers
  function refreshUI(){
    balanceEl.textContent = `${balance} ‚ÇΩ`;
    vaultEl.textContent = `${vault} ‚ÇΩ`;
    renderBigWins();
  }

  function renderBigWins(){
    bigListEl.innerHTML = '';
    if (!bigWins || bigWins.length === 0){ bigListEl.innerHTML = '<div style="color:var(--muted);padding:8px">–ü–æ–∫–∞ –Ω–µ—Ç –±–æ–ª—å—à–∏—Ö –≤—ã–∏–≥—Ä—ã—à–µ–π</div>'; return; }
    bigWins.slice(0,50).forEach(it=>{
      const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.padding='8px'; row.style.borderBottom='1px solid rgba(255,255,255,0.02)';
      const left = document.createElement('div'); left.style.display='flex'; left.style.gap='8px'; left.style.alignItems='center';
      const em = document.createElement('div'); em.textContent = it.emoji || 'üéâ'; em.style.fontSize = '18px';
      const info = document.createElement('div'); const n=document.createElement('div'); n.style.fontWeight='700'; n.textContent = it.nick;
      const t = document.createElement('div'); t.style.fontSize='12px'; t.style.color='var(--muted)'; t.textContent = new Date(it.ts).toLocaleString();
      info.appendChild(n); info.appendChild(t); left.appendChild(em); left.appendChild(info);
      const right = document.createElement('div'); right.style.color='var(--accent)'; right.textContent = `+${it.amount} ‚ÇΩ`;
      row.appendChild(left); row.appendChild(right); bigListEl.appendChild(row);
    });
  }

  function addBigWin(rec){
    bigWins.unshift(rec);
    if (bigWins.length > 200) bigWins = bigWins.slice(0,200);
    localStorage.setItem('localBigWins', JSON.stringify(bigWins));
    renderBigWins();
  }

  // effects helpers
  function flash(duration=240){
    const overlay = document.createElement('div');
    overlay.style.position='fixed'; overlay.style.inset='0'; overlay.style.pointerEvents='none';
    overlay.style.background='radial-gradient(circle at 50% 30%, rgba(255,245,220,0.95), rgba(255,245,220,0.4) 10%, transparent 30%)';
    overlay.style.zIndex='110'; overlay.style.opacity='0';
    document.body.appendChild(overlay);
    requestAnimationFrame(()=> overlay.style.opacity='1');
    setTimeout(()=> { overlay.style.opacity='0'; setTimeout(()=> overlay.remove(), 200); }, duration);
  }

  function showBadge(amount){
    winBadge.innerHTML = `BIG WIN<div style="font-size:16px;font-weight:700;margin-top:6px">+${amount} ‚ÇΩ</div>`;
    winBadge.classList.add('show');
    setTimeout(()=> winBadge.classList.remove('show'), 2400);
  }

  // sound
  function playWin(level='small'){
    if (!audioCtx) return;
    if (level==='small') tone(880,0.06,'sine',0.05);
    else if (level==='big'){ tone(540,0.14,'triangle',0.11); tone(1300,0.12,'sine',0.08); }
    else { tone(420,0.26,'sawtooth',0.14); tone(1100,0.22,'sine',0.12); }
  }

  // spin flow
  function runSpin(){
    let bet = Math.floor(Number(betInput.value) || 0);
    if (bet < 1) bet = 1;
    if (bet > balance){ alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤'); return; }
    balance -= bet; localStorage.setItem('balance', String(balance)); refreshUI();
    spinBtn.disabled = true;

    const luck = 1 + (Math.log((Number(onlineEl.textContent) || 1)+1) * 0.05);
    const favor = Math.min(0.28*(luck-1), 0.45);
    const arr = [];
    for (let i=0;i<SLOT_COUNT;i++){
      if (i>0 && Math.random() < favor){
        if (Math.random() < 0.68) arr.push(arr[i-1]); else arr.push(arr[Math.floor(Math.random()*i)]);
      } else arr.push(EMOJI[Math.floor(Math.random()*EMOJI.length)]);
    }

    animateGrid(arr);

    const lines = computeLines(arr);
    const p = payout(bet, lines);

    setTimeout(()=>{
      if (p.payout > 0){ balance += p.payout; localStorage.setItem('balance', String(balance)); }
      const net = p.payout - bet;
      if (net > 0) scoreEl.textContent = `BIG WIN! +${net} ‚ÇΩ  (payout ${p.payout} ‚ÇΩ)`;
      else if (net === 0) scoreEl.textContent = `–ù–∏—á—å—è ‚Äî ${p.payout} ‚ÇΩ`;
      else scoreEl.textContent = `–ü—Ä–æ–∏–≥—Ä—ã—à ${-net} ‚ÇΩ`;
      scoreEl.classList.remove('pop'); void scoreEl.offsetWidth; scoreEl.classList.add('pop');

      const rect = gridEl.getBoundingClientRect();
      if (net >= 800){
        spawnParticles(rect.left + rect.width/2, rect.top + rect.height/2, 260, 320, 26, ['#ffd166','#fff59d','#6ee7b7','#60a5fa','#f472b6']);
        flash(420); playWin('huge'); showBadge(net);
      } else if (net >= 200){
        spawnParticles(rect.left + rect.width/2, rect.top + rect.height/2, 120, 220, 18);
        flash(260); playWin('big'); showBadge(net);
      } else if (net > 0){
        spawnParticles(rect.left + rect.width/2, rect.top + rect.height/2, 40, 120, 12);
        playWin('small');
      }

      animateGrid(arr, p.winCells);

      if (net >= 50) addBigWin({ nick: nickInput.value || nick, emoji: lines.find(l=>l.bestCount>=3)?.emoji || arr[4], amount: net, bet, payout: p.payout, multiplier: p.multiplier, ts: Date.now() });

      spinBtn.disabled = false;
      refreshUI();
    }, 640);
  }

  // daily dice
  function canDaily(){ const last = Number(localStorage.getItem('lastDaily') || 0); return (Date.now() - last) >= 24*60*60*1000; }
  dailyBtn.addEventListener('click', ()=>{
    if (!canDaily()){ alert('–ö—É–±–∏–∫ –¥–æ—Å—Ç—É–ø–µ–Ω —Ä–∞–∑ –≤ 24 —á–∞—Å–∞'); return; }
    const roll = Math.floor(Math.random()*6)+1; const reward = 100*roll;
    balance += reward; localStorage.setItem('balance', String(balance));
    localStorage.setItem('lastDaily', String(Date.now()));
    addBigWin({ nick: nickInput.value || nick, emoji: 'üé≤', amount: reward, bet:0, payout:reward, multiplier:0, ts: Date.now() });
    const rect = gridEl.getBoundingClientRect();
    spawnParticles(rect.left + rect.width/2, rect.top + rect.height/2, 160, 220, 18);
    flash(300); playWin('big'); showBadge(reward);
    refreshUI();
    alert(`–í—ã–ø–∞–ª–æ ${roll} ‚Äî +${reward} ‚ÇΩ`);
  });

  // bindings
  spinBtn.addEventListener('click', ()=> { try{ if (audioCtx && audioCtx.state==='suspended') audioCtx.resume(); }catch(e){}; runSpin(); });
  minBtn.addEventListener('click', ()=> betInput.value = 1);
  halfBtn.addEventListener('click', ()=> betInput.value = Math.max(1, Math.floor(balance/2)));
  maxBtn.addEventListener('click', ()=> betInput.value = balance);
  saveNickBtn.addEventListener('click', ()=> { nick = nickInput.value || 'Player'; localStorage.setItem('nick', nick); alert('–ù–∏–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω'); });
  clearBigBtn.addEventListener('click', ()=> { if (!confirm('–û—á–∏—Å—Ç–∏—Ç—å —Å–ø–∏—Å–æ–∫ –±–æ–ª—å—à–∏—Ö –≤—ã–∏–≥—Ä—ã—à–µ–π?')) return; bigWins=[]; localStorage.removeItem('localBigWins'); renderBigWins(); });

  // initial UI
  refreshUI();
  setInterval(()=> { const n = Math.max(1, Math.floor(Math.random()*12)+2); onlineEl.textContent = n; luckEl.textContent = (1 + 0.06 * Math.log(n + 1)).toFixed(2); }, 4200);

  </script>
</body>
</html>
