
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Emoji Flux ‚Äî Immediate Results, Themes & Purchases</title>
  <style>
    :root{
      --bg1:#071029; --bg2:#0b1830;
      --card: rgba(255,255,255,0.02);
      --accent:#ffd166; --muted:#bcd3ea;
      --slot-size:90px; --slot-gap:12px;
      --ui-font: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:var(--ui-font); color:var(--muted);
      background: linear-gradient(180deg,var(--bg1),var(--bg2));
      -webkit-font-smoothing:antialiased; display:flex;flex-direction:column;align-items:center;padding:18px;
    }

    header{width:100%;max-width:1200px;display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
    .brand{font-weight:800;color:var(--accent)}
    .controls{display:flex;gap:12px;align-items:center}

    .panel{width:100%;max-width:1200px;background:var(--card);border-radius:12px;padding:16px;box-shadow:0 20px 60px rgba(0,0,0,0.6)}
    .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .score{font-weight:700;padding:6px 10px;border-radius:10px;background:rgba(255,255,255,0.02)}

    .grid{display:grid;grid-template-columns:repeat(3,var(--slot-size));grid-gap:var(--slot-gap);justify-content:center;padding:12px;border-radius:10px}
    .slot{
      height:var(--slot-size); width:var(--slot-size); border-radius:12px; display:flex;align-items:center;justify-content:center;
      font-size:44px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.008));
      box-shadow:0 12px 36px rgba(0,0,0,0.6), inset 0 -8px 16px rgba(0,0,0,0.22);
      transition: transform .22s, box-shadow .18s, filter .18s;
    }
    .slot.enter{opacity:0; transform: translateY(-28px) scale(.96); animation:slot-in .46s cubic-bezier(.2,.9,.3,1) var(--delay) both}
    @keyframes slot-in{0%{opacity:0;transform:translateY(-28px) scale(.96)}60%{transform:translateY(6px) scale(1.06)}100%{opacity:1;transform:translateY(0) scale(1)}}
    .slot.win{transform:scale(1.08); box-shadow:0 28px 80px rgba(255,200,80,0.14); filter:brightness(1.12)}

    .actions{display:flex;gap:12px;justify-content:center;margin-top:12px}
    button{padding:10px 14px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--accent),#ffb86b);cursor:pointer;font-weight:700;color:#08101a}

    main{display:flex;gap:18px;width:100%;max-width:1200px;align-items:flex-start}
    aside{width:380px;display:flex;flex-direction:column;gap:12px;margin-top:12px}
    .aside-section{background:var(--card);padding:12px;border-radius:10px}
    .muted{color:var(--muted);font-size:0.92rem}
    .balance{font-weight:800;color:var(--accent)}

    .purchase{display:flex;align-items:center;justify-content:space-between;margin-top:8px}
    .purchase button{padding:8px;border-radius:8px}
    .purchased{opacity:0.6}

    canvas#confetti{position:fixed;left:0;top:0;pointer-events:none;z-index:120}
    select, input[type="text"], input[type="number"]{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
    label.small{font-size:0.92rem;color:var(--muted);margin-right:8px}
    .theme-preview{font-size:20px;opacity:0.95}
    @media (max-width:980px){ main{flex-direction:column} aside{width:100%} }
  </style>
</head>
<body>
  <canvas id="confetti"></canvas>

  <header>
    <div style="display:flex;gap:12px;align-items:center">
      <div class="brand">Emoji Flux</div>
      <div style="display:flex;flex-direction:column">
        <div style="font-size:0.85rem;color:var(--muted)">–¢–µ–º–∞ (Emoji‚Äë—Å–µ—Ç—ã)</div>
        <select id="themeSelect" aria-label="–í—ã–±–æ—Ä —Ç–µ–º—ã">
          <option value="fruits">Fruits (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)</option>
          <option value="cyberpunk">–ö–∏–±–µ—Ä–ø–∞–Ω–∫</option>
          <option value="magic">–ú–∞–≥–∏—è</option>
          <option value="crypto">–ö—Ä–∏–ø—Ç–æ</option>
        </select>
      </div>
    </div>

    <div class="controls">
      <input id="nick" placeholder="–ù–∏–∫–Ω–µ–π–º" />
      <button id="saveNick">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </header>

  <main>
    <section style="flex:1">
      <div class="panel">
        <div class="top">
          <div style="display:flex;gap:12px;align-items:center">
            <label class="small">–°—Ç–∞–≤–∫–∞</label>
            <input id="bet" type="number" value="20" min="1" style="width:110px" />
            <button id="min">–ú–∏–Ω</button>
            <button id="half">1/2</button>
            <button id="max">–ú–∞–∫—Å</button>
          </div>
          <div class="score" id="score">–ù–∞–∂–º–∏—Ç–µ Spin</div>
        </div>

        <div class="grid" id="grid" role="grid" aria-live="polite"></div>

        <div class="actions">
          <button id="spin">Spin</button>
          <button id="daily">–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –∫—É–±–∏–∫</button>
          <button id="reset">–°–±—Ä–æ—Å</button>
        </div>
      </div>
    </section>

    <aside>
      <div class="aside-section">
        <div>–ë–∞–ª–∞–Ω—Å: <span class="balance" id="balance">‚Äî</span></div>
        <div class="muted">Vault: <span id="vault">0</span></div>
        <div style="margin-top:8px">–¢–µ–∫—É—â–∞—è —Ç–µ–º–∞: <span id="themePreview" class="theme-preview"></span></div>
      </div>

      <div class="aside-section">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">–ú–∞–≥–∞–∑–∏–Ω (–ø–∞—Å—Å–∏–≤–Ω—ã–µ –±–æ–Ω—É—Å—ã)</div>
        </div>
        <div class="purchase" id="buyLeftWrap">
          <div>Left Side Module ‚Äî 120000 ‚ÇΩ</div>
          <button id="buyLeft">–ö—É–ø–∏—Ç—å</button>
        </div>
        <div class="purchase" id="buyRightWrap">
          <div>Right Side Module ‚Äî 120000 ‚ÇΩ</div>
          <button id="buyRight">–ö—É–ø–∏—Ç—å</button>
        </div>
        <div class="purchase" id="buyBoosterWrap">
          <div>Booster (x2 payouts) ‚Äî 120000 ‚ÇΩ</div>
          <button id="buyBooster">–ö—É–ø–∏—Ç—å</button>
        </div>
        <div class="purchase" id="buyInsuranceWrap">
          <div>Insurance (50% –ø—Ä–∏ –ø—Ä–æ–∏–≥—Ä—ã—à–µ) ‚Äî 50000 ‚ÇΩ</div>
          <button id="buyInsurance">–ö—É–ø–∏—Ç—å</button>
        </div>
      </div>

      <div class="aside-section">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">–ë–æ–ª—å—à–∏–µ –≤—ã–∏–≥—Ä—ã—à–∏</div>
          <button id="clearBig">–û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
        <div id="bigList" style="margin-top:8px;max-height:260px;overflow:auto"></div>
      </div>
    </aside>
  </main>

  <script>
  // Immediate-result version with themes, 11% repeat chance and passive purchases (variant 2).
  (function(){
    // CONFIG
    const THEMES = {
      fruits: ['üçí','üçã','üîî','‚≠ê','üçÄ'],
      cyberpunk: ['ü§ñ','‚ö°Ô∏è','üíæ','ü¶æ','üï∂Ô∏è'],
      magic: ['üîÆ','üìú','üß™','üßô','üïØÔ∏è'],
      crypto: ['üöÄ','üåô','üìà','üíé','ü¶Å']
    };
    const DEFAULT_THEME = localStorage.getItem('theme') || 'fruits';
    const ROWS = 3, COLS = 3, SLOT_COUNT = ROWS * COLS;
    const REPEAT_CHANCE = 0.11; // 11%
    const COST_SIDE = 120000, COST_BOOSTER = 120000, COST_INSURANCE = 50000;

    // DOM
    const gridEl = document.getElementById('grid');
    const balanceEl = document.getElementById('balance');
    const vaultEl = document.getElementById('vault');
    const scoreEl = document.getElementById('score');
    const bigListEl = document.getElementById('bigList');
    const confettiCanvas = document.getElementById('confetti');

    const themeSelect = document.getElementById('themeSelect');
    const themePreview = document.getElementById('themePreview');

    const nickInput = document.getElementById('nick');
    const saveNickBtn = document.getElementById('saveNick');
    const spinBtn = document.getElementById('spin');
    const dailyBtn = document.getElementById('daily');
    const resetBtn = document.getElementById('reset');
    const betInput = document.getElementById('bet');
    const minBtn = document.getElementById('min');
    const halfBtn = document.getElementById('half');
    const maxBtn = document.getElementById('max');
    const clearBigBtn = document.getElementById('clearBig');

    const buyLeftBtn = document.getElementById('buyLeft');
    const buyRightBtn = document.getElementById('buyRight');
    const buyBoosterBtn = document.getElementById('buyBooster');
    const buyInsuranceBtn = document.getElementById('buyInsurance');

    // STATE (persist)
    let theme = localStorage.getItem('theme') || DEFAULT_THEME;
    let emojiPool = THEMES[theme] || THEMES.fruits;

    let nick = localStorage.getItem('nick') || 'Player';
    nickInput.value = nick;

    let balance = Number(localStorage.getItem('balance')) || 1000;
    let vault = Number(localStorage.getItem('vault')) || 0;
    let bigWins = JSON.parse(localStorage.getItem('localBigWins') || '[]');

    let purchasedLeft = localStorage.getItem('purchasedLeft') === '1';
    let purchasedRight = localStorage.getItem('purchasedRight') === '1';
    let purchasedBooster = localStorage.getItem('purchasedBooster') === '1';
    let purchasedInsurance = localStorage.getItem('purchasedInsurance') === '1';

    // protect against concurrent spins
    let isSpinning = false;

    // safe storage
    function safeSetItem(k,v){ try{ localStorage.setItem(k,v); }catch(e){} }

    // --- confetti ---
    const ctx = confettiCanvas.getContext('2d');
    let W=0,H=0, parts=[], confettiAnimating=false;
    function resize(){ W=confettiCanvas.width = innerWidth; H=confettiCanvas.height = innerHeight; }
    addEventListener('resize', resize); resize();
    function spawnConfetti(x,y,n,spread=120,power=14){
      for (let i=0;i<n;i++){
        parts.push({
          x: x + (Math.random()-0.5)*spread,
          y: y + (Math.random()-0.5)*spread,
          vx:(Math.random()-0.5)*power,
          vy: -Math.random()*power - 2,
          r: Math.random()*10+4,
          col: ['#ffd166','#6ee7b7','#60a5fa','#f472b6','#fff59d'][Math.floor(Math.random()*5)],
          life:0, ttl: 80 + Math.floor(Math.random()*120)
        });
      }
      if (!confettiAnimating) confettiLoop();
    }
    function confettiLoop(){
      confettiAnimating = true;
      ctx.clearRect(0,0,W,H);
      for (let i=parts.length-1;i>=0;i--){
        const p = parts[i];
        p.life++; p.vy += 0.35; p.x += p.vx; p.y += p.vy;
        ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.life*0.07);
        ctx.fillStyle = p.col; ctx.fillRect(-p.r/2, -p.r/2, p.r, p.r*0.6); ctx.restore();
        if (p.y > H + 50 || p.life > p.ttl) parts.splice(i,1);
      }
      if (parts.length>0) requestAnimationFrame(confettiLoop); else confettiAnimating = false;
    }

    // --- grid helpers ---
    function createGrid(){
      gridEl.innerHTML = '';
      for (let i=0;i<SLOT_COUNT;i++){
        const slot = document.createElement('div');
        slot.className = 'slot';
        slot.textContent = emojiPool[i % emojiPool.length];
        gridEl.appendChild(slot);
      }
    }
    createGrid();

    function animateGrid(values, winIndices=[]){
      const slots = Array.from(gridEl.children);
      slots.forEach((s,i)=>{
        s.className = 'slot enter';
        s.style.setProperty('--delay', `${(i%COLS)*0.04}s`);
        s.textContent = values[i] || '‚ùî';
        const onEnd = () => {
          s.classList.remove('enter');
          s.removeEventListener('animationend', onEnd);
          if (winIndices.includes(i)){
            s.classList.add('win'); setTimeout(()=> s.classList.remove('win'), 1000);
          }
        };
        s.addEventListener('animationend', onEnd);
      });
    }

    // --- lines & payouts ---
    function computeLines(arr){
      const lines = [];
      for (let r=0;r<ROWS;r++) lines.push([arr[r*COLS], arr[r*COLS+1], arr[r*COLS+2]]);
      for (let c=0;c<COLS;c++) lines.push([arr[c], arr[3+c], arr[6+c]]);
      lines.push([arr[0],arr[4],arr[8]]);
      lines.push([arr[2],arr[4],arr[6]]);
      return lines.map(vals=>{
        const freq={}; vals.forEach(v=> freq[v] = (freq[v]||0)+1);
        const best = Math.max(...Object.values(freq));
        const emoji = Object.keys(freq).find(k=>freq[k]===best);
        return { vals, bestCount: best, emoji };
      });
    }

    function payoutFromLines(bet, lineResults){
      let totalMul = 0, winCells = [];
      lineResults.forEach((lr, idx)=>{
        const c = lr.bestCount;
        if (c >= 3){
          totalMul += (c === 3 ? 3 : (c === 4 ? 6 : 12));
          if (idx < 3){ const r = idx; for (let cc=0; cc<COLS; cc++) winCells.push(r*COLS + cc); }
          else if (idx < 6){ const cc = idx - 3; for (let rr=0; rr<ROWS; rr++) winCells.push(rr*COLS + cc); }
          else if (idx === 6) winCells.push(0,4,8); else winCells.push(2,4,6);
        } else if (c === 2) totalMul += 0.6;
      });
      totalMul = Math.min(totalMul, 50);
      let passiveMultiplier = 1;
      const sideCount = (purchasedLeft ? 1 : 0) + (purchasedRight ? 1 : 0);
      passiveMultiplier += sideCount * 0.5;
      if (purchasedBooster) passiveMultiplier *= 2;
      const payout = Math.round(bet * totalMul * passiveMultiplier);
      return { payout, net: payout - bet, totalMul, passiveMultiplier, winCells: [...new Set(winCells)] };
    }

    // ---------- RNG (11% repeat) ----------
    function generateGrid(){
      const online = Number(document.getElementById('online').textContent) || 1;
      const favor = Math.min(0.28 * (Math.log(online + 1) * 0.05), 0.45);
      const res = [];
      for (let i=0;i<SLOT_COUNT;i++){
        if (i>0 && Math.random() < REPEAT_CHANCE){
          res.push(res[i-1]);
          continue;
        }
        if (i>0 && Math.random() < favor){
          if (Math.random() < 0.68) res.push(res[i-1]);
          else res.push(res[Math.floor(Math.random()*i)]);
        } else {
          res.push(emojiPool[Math.floor(Math.random()*emojiPool.length)]);
        }
      }
      return res;
    }

    // ---------- RUN SPIN (IMMEDIATE RESULT) ----------
    function runSpin(){
      if (isSpinning) return; // protect, though result is immediate
      isSpinning = true;
      spinBtn.disabled = true;

      let bet = Math.floor(Number(betInput.value) || 0);
      if (bet < 1) bet = 1;
      if (bet > balance){ alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤'); isSpinning = false; spinBtn.disabled = false; return; }

      // Immediately deduct bet and persist
      balance -= bet; safeSetItem('balance', String(balance));
      refreshUI();

      // compute result immediately (no waiting)
      const grid = generateGrid();
      const lines = computeLines(grid);
      const payoutObj = payoutFromLines(bet, lines);

      // apply payout or insurance immediately
      if (payoutObj.payout > 0){
        balance += payoutObj.payout;
        safeSetItem('balance', String(balance));
      } else {
        if (purchasedInsurance){
          const refund = Math.floor(bet / 2);
          balance += refund;
          safeSetItem('balance', String(balance));
        }
      }

      // prepare and show immediate textual result
      const net = payoutObj.payout - bet;
      if (net > 0) scoreEl.textContent = `BIG WIN! +${net} ‚ÇΩ (–≤—ã–ø–ª–∞—Ç–∞ ${payoutObj.payout} ‚ÇΩ)`;
      else if (net === 0) scoreEl.textContent = `–ù–∏—á—å—è ‚Äî –≤–æ–∑–≤—Ä–∞—â–µ–Ω–æ ${payoutObj.payout} ‚ÇΩ`;
      else scoreEl.textContent = purchasedInsurance ? `–ü—Ä–æ–∏–≥—Ä—ã—à ‚Äî –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø–æ–ª–æ–≤–∏–Ω–∞ —Å—Ç–∞–≤–∫–∏` : `–ü—Ä–æ–∏–≥—Ä—ã—à ${-net} ‚ÇΩ`;

      // animate grid (visual), highlight winners
      animateGrid(grid, payoutObj.winCells);

      // visual FX
      const rect = gridEl.getBoundingClientRect();
      if (net >= 800) { spawnConfetti(rect.left + rect.width/2, rect.top + rect.height/2, 260); showBadge(net); }
      else if (net >= 200) { spawnConfetti(rect.left + rect.width/2, rect.top + rect.height/2, 120); showBadge(net); }
      else if (net > 0) { spawnConfetti(rect.left + rect.width/2, rect.top + rect.height/2, 48); }

      // record bigWins if notable
      const actualNet = payoutObj.payout - bet;
      if (actualNet >= 50){
        bigWins.unshift({ nick: nickInput.value || nick, emoji: lines.find(l=>l.bestCount>=3)?.emoji || grid[4], amount: actualNet, bet, payout: payoutObj.payout, ts: Date.now() });
        if (bigWins.length > 200) bigWins = bigWins.slice(0,200);
        safeSetItem('localBigWins', JSON.stringify(bigWins));
      }

      // finalize
      isSpinning = false;
      spinBtn.disabled = false;
      refreshUI();
    }

    // ---------- purchases ----------
    function updatePurchaseUI(){
      buyLeftBtn.disabled = purchasedLeft || balance < COST_SIDE;
      buyRightBtn.disabled = purchasedRight || balance < COST_SIDE;
      buyBoosterBtn.disabled = purchasedBooster || balance < COST_BOOSTER;
      buyInsuranceBtn.disabled = purchasedInsurance || balance < COST_INSURANCE;

      document.getElementById('buyLeftWrap').classList.toggle('purchased', purchasedLeft);
      document.getElementById('buyRightWrap').classList.toggle('purchased', purchasedRight);
      document.getElementById('buyBoosterWrap').classList.toggle('purchased', purchasedBooster);
      document.getElementById('buyInsuranceWrap').classList.toggle('purchased', purchasedInsurance);
    }

    buyLeftBtn.addEventListener('click', ()=>{
      if (purchasedLeft) return;
      if (balance < COST_SIDE) { alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤'); return; }
      if (!confirm(`–ö—É–ø–∏—Ç—å Left Side Module –∑–∞ ${COST_SIDE} ‚ÇΩ?`)) return;
      balance -= COST_SIDE; safeSetItem('balance', String(balance));
      purchasedLeft = true; safeSetItem('purchasedLeft','1');
      updatePurchaseUI(); refreshUI(); alert('Left Side Module –ø—Ä–∏–æ–±—Ä–µ—Ç—ë–Ω.');
    });

    buyRightBtn.addEventListener('click', ()=>{
      if (purchasedRight) return;
      if (balance < COST_SIDE) { alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤'); return; }
      if (!confirm(`–ö—É–ø–∏—Ç—å Right Side Module –∑–∞ ${COST_SIDE} ‚ÇΩ?`)) return;
      balance -= COST_SIDE; safeSetItem('balance', String(balance));
      purchasedRight = true; safeSetItem('purchasedRight','1');
      updatePurchaseUI(); refreshUI(); alert('Right Side Module –ø—Ä–∏–æ–±—Ä–µ—Ç—ë–Ω.');
    });

    buyBoosterBtn.addEventListener('click', ()=>{
      if (purchasedBooster) return;
      if (balance < COST_BOOSTER) { alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤'); return; }
      if (!confirm(`–ö—É–ø–∏—Ç—å Booster (x2 payouts) –∑–∞ ${COST_BOOSTER} ‚ÇΩ?`)) return;
      balance -= COST_BOOSTER; safeSetItem('balance', String(balance));
      purchasedBooster = true; safeSetItem('purchasedBooster','1');
      updatePurchaseUI(); refreshUI(); alert('Booster –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω.');
    });

    buyInsuranceBtn.addEventListener('click', ()=>{
      if (purchasedInsurance) return;
      if (balance < COST_INSURANCE) { alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤'); return; }
      if (!confirm(`–ö—É–ø–∏—Ç—å Insurance (50% –ø—Ä–∏ –ø—Ä–æ–∏–≥—Ä—ã—à–µ) –∑–∞ ${COST_INSURANCE} ‚ÇΩ?`)) return;
      balance -= COST_INSURANCE; safeSetItem('balance', String(balance));
      purchasedInsurance = true; safeSetItem('purchasedInsurance','1');
      updatePurchaseUI(); refreshUI(); alert('Insurance –∫—É–ø–ª–µ–Ω–∞.');
    });

    // ---------- daily ----------
    function canDaily(){ const last = Number(localStorage.getItem('lastDaily') || 0); return (Date.now() - last) >= 24*60*60*1000; }
    dailyBtn.addEventListener('click', ()=>{
      if (!canDaily()){ alert('–ö—É–±–∏–∫ –¥–æ—Å—Ç—É–ø–µ–Ω —Ä–∞–∑ –≤ 24 —á–∞—Å–∞'); return; }
      const roll = Math.floor(Math.random()*6)+1;
      const reward = 100 * roll;
      balance += reward; safeSetItem('balance', String(balance));
      safeSetItem('lastDaily', String(Date.now()));
      bigWins.unshift({ nick: nickInput.value || nick, emoji: 'üé≤', amount: reward, bet:0, payout:reward, ts: Date.now() });
      if (bigWins.length > 200) bigWins = bigWins.slice(0,200);
      safeSetItem('localBigWins', JSON.stringify(bigWins));
      const rect = gridEl.getBoundingClientRect();
      spawnConfetti(rect.left + rect.width/2, rect.top + rect.height/2, 120);
      scoreEl.textContent = `–ö—É–±–∏–∫: ${roll} ‚Äî +${reward} ‚ÇΩ`;
      refreshUI();
      alert(`–í—ã–ø–∞–ª–æ ${roll} ‚Äî +${reward} ‚ÇΩ`);
    });

    // ---------- theme ----------
    function applyTheme(t){
      theme = t;
      emojiPool = THEMES[theme] || THEMES.fruits;
      safeSetItem('theme', theme);
      themePreview.textContent = emojiPool.join(' ');
      // reseed grid visually
      const base = Array.from({length:SLOT_COUNT}, (_,i) => emojiPool[i % emojiPool.length]);
      animateGrid(base);
    }
    themeSelect.value = theme;
    applyTheme(theme);
    themeSelect.addEventListener('change', (e)=> applyTheme(e.target.value));

    // ---------- misc UI ----------
    function refreshUI(){
      balanceEl.textContent = `${balance} ‚ÇΩ`;
      vaultEl.textContent = `${vault} ‚ÇΩ`;
      renderBigWins();
      updatePurchaseUI();
    }

    function renderBigWins(){
      bigListEl.innerHTML = '';
      if (!bigWins || bigWins.length === 0){
        bigListEl.innerHTML = '<div style="color:var(--muted);padding:8px">–ü–æ–∫–∞ –Ω–µ—Ç –±–æ–ª—å—à–∏—Ö –≤—ã–∏–≥—Ä—ã—à–µ–π</div>';
        return;
      }
      bigWins.slice(0,50).forEach(it=>{
        const row = document.createElement('div');
        row.style.display='flex'; row.style.justifyContent='space-between'; row.style.padding='8px'; row.style.borderBottom='1px solid rgba(255,255,255,0.02)';
        const left = document.createElement('div'); left.style.display='flex'; left.style.gap='8px'; left.style.alignItems='center';
        const em = document.createElement('div'); em.textContent = it.emoji || 'üéâ'; em.style.fontSize='18px';
        const info = document.createElement('div'); const n = document.createElement('div'); n.style.fontWeight='700'; n.textContent = it.nick;
        const t = document.createElement('div'); t.style.fontSize='12px'; t.style.color='var(--muted)'; t.textContent = new Date(it.ts).toLocaleString();
        info.appendChild(n); info.appendChild(t); left.appendChild(em); left.appendChild(info);
        const right = document.createElement('div'); right.style.color='var(--accent)'; right.textContent = `+${it.amount} ‚ÇΩ`;
        row.appendChild(left); row.appendChild(right); bigListEl.appendChild(row);
      });
    }

    function showBadge(amount){
      const badge = document.createElement('div');
      badge.style.position='fixed'; badge.style.left='50%'; badge.style.top='8%'; badge.style.transform='translateX(-50%)';
      badge.style.zIndex='999'; badge.style.fontFamily="'Bebas Neue', sans-serif"; badge.style.fontSize='44px';
      badge.style.color='#08101a'; badge.style.padding='12px 24px'; badge.style.borderRadius='12px';
      badge.style.background='linear-gradient(90deg,#fff1c8,#ffd166)';
      badge.textContent = `BIG WIN +${amount} ‚ÇΩ`;
      document.body.appendChild(badge);
      setTimeout(()=> { badge.style.transition='opacity .45s'; badge.style.opacity='0'; setTimeout(()=> badge.remove(), 480); }, 1800);
    }

    // ---------- bindings ----------
    spinBtn.addEventListener('click', ()=> runSpin());
    minBtn.addEventListener('click', ()=> betInput.value = 1);
    halfBtn.addEventListener('click', ()=> betInput.value = Math.max(1, Math.floor(balance/2)));
    maxBtn.addEventListener('click', ()=> betInput.value = balance);
    saveNickBtn.addEventListener('click', ()=> { nick = nickInput.value || 'Player'; safeSetItem('nick', nick); alert('–ù–∏–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω'); });
    clearBigBtn.addEventListener('click', ()=> { if (!confirm('–û—á–∏—Å—Ç–∏—Ç—å —Å–ø–∏—Å–æ–∫ –±–æ–ª—å—à–∏—Ö –≤—ã–∏–≥—Ä—ã—à–µ–π?')) return; bigWins=[]; safeSetItem('localBigWins','[]'); renderBigWins(); });

    resetBtn.addEventListener('click', ()=> { if (!confirm('–°–±—Ä–æ—Å–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ?')) return; localStorage.clear(); location.reload(); });

    // simulated online
    setInterval(()=> {
      const n = Math.max(1, Math.floor(Math.random()*12)+2);
      document.getElementById('online').textContent = n;
      document.getElementById('luck').textContent = (1 + 0.06 * Math.log(n + 1)).toFixed(2);
    }, 3500);

    // initial seed & UI
    (function seed(){
      const base = Array.from({length:SLOT_COUNT}, (_,i) => emojiPool[i % emojiPool.length]);
      animateGrid(base);
      refreshUI();
    })();

    // expose for debugging
    window._emojiFlux = { runSpin, applyTheme };
  })();
  </script>
</body>
</html>
